---
title: "Как создать обратный прокси в Nginx"
date: 2024-05-03
description: "Обратный прокси-сервер является посредником для клиентских запросов, распределяя их на один или несколько внутренних серверов. Такая настройка обеспечивает балансировку нагрузки, повышает безопасность и обеспечивает высокую доступность. Использование NGINX в качестве обратного прокси-сервера может повысить масштабируемость и надежность ваших веб-сервисов."
tags: ["NGINX", "Linux", "WWWW","Proxy"]
type: post
weight: 20
showTableOfContents: true
---
## Создание и настройка обратного прокси в Nginx
### Настройка базового обратного прокси-сервера в Nginx
Во-первых, чтобы начать настройку Nginx как обратного прокси, откройте файл конфигурации Nginx. Обычно этот файл находится по адресу `/etc/nginx/nginx.conf`. Откройте его с помощью предпочитаемого вами текстового редактора, например, с помощью sudo Nano:
```
sudo nano /etc/nginx/nginx.conf
```
Внутри файла конфигурации сфокусируйтесь на блоке `http`. Здесь вы вставите блок сервера, краеугольный камень вашей настройки обратного прокси. Блок сервера прослушивает указанный порт, обычно порт 80, на предмет HTTP-трафика. Внутри этого блока `location/directive` сообщает Nginx, как обрабатывать входящие запросы. Используйте директиву proxy_pass, чтобы перенаправить эти запросы на внутренний сервер, указанный его IP-адресом или именем хоста.

**Например, конфигурация может выглядеть так:**
```
http {
    ...
    server {
        listen 80;
        location / {
            proxy_pass http://backendserver_address;
        }
    }
}
```
Не забудьте заменить `backendserver_address` на фактический адрес вашего бэкенд-сервера. Эта простая настройка сообщает Nginx о необходимости пересылать все входящие HTTP-запросы на указанный бэкенд-сервер.

## Расширенная настройка обратного прокси-сервера в Nginx
В более продвинутой настройке вам может понадобиться настроить дополнительные аспекты обратного прокси-сервера. Это может включать настройки балансировки нагрузки, терминации SSL или кэширования.

## Реализация балансировки нагрузки
Если вы используете несколько внутренних серверов, Nginx может распределить входящий трафик между ними, повышая производительность и надежность. Для балансировки нагрузки вам следует изменить директиву proxy_pass, чтобы она указывала на группу серверов, определенных в блоке `upstream`. Например:
```
http {
    upstream backend_servers {
        server backend1.example.com;
        server backend2.example.com;
    }

    server {
        listen 80;
        location / {
            proxy_pass http://backend_servers;
        }
    }
}
```
Такая конфигурация позволяет Nginx балансировать нагрузку между backend1.example.com и backend2.example.com.

### Настройка завершения SSL
Для завершения SSL убедитесь, что блок сервера прослушивает порт 443 и включает расположение файлов сертификата и ключа SSL. Конфигурация может выглядеть следующим образом:
```
server {
    listen 443 ssl;
    ssl_certificate /path/to/certificate.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://backendserver_address;
    }
}
```
Такая настройка позволяет Nginx обрабатывать SSL-соединения и расшифровывать запросы перед их передачей на внутренние серверы.

### Завершение изменений
После настройки Nginx проверьте конфигурацию на наличие синтаксических ошибок с помощью:
```
nginx -t
```
Если тест пройден, перезагрузите Nginx, чтобы применить изменения, используя:
```
sudo systemctl reload nginx
```
Этот шаг гарантирует, что ваши изменения вступят в силу без прерывания текущих подключений.

## Настройка значений заголовков прокси-сервера Nginx
При настройке Nginx в качестве обратного прокси-сервера важно правильно задать значения заголовков прокси. Эти заголовки имеют решающее значение для передачи исходных данных клиентского запроса на внутренние серверы. Эта информация может включать IP-адрес клиента, исходный протокол запроса и многое другое. Правильная настройка этих заголовков гарантирует, что внутренние серверы будут иметь контекст, необходимый для надлежащего ответа на запросы.

### Понимание заголовков прокси
Заголовки прокси-сервера необходимы в настройке обратного прокси-сервера, поскольку они несут информацию об исходном запросе клиента. Эта информация необходима внутренним серверам для принятия обоснованных решений об обработке входящих запросов. Например, знание исходного IP-адреса клиента может быть важно для ведения журнала, аналитики или в целях безопасности.

### Общие конфигурации заголовков прокси-сервера
Вот некоторые из распространенных заголовков прокси-сервера, которые можно настроить в Nginx:

- X-Real-IP: Этот заголовок используется для передачи исходного IP-адреса клиента на внутренний сервер.
- X-Forwarded-For: Подобно X-Real-IP, этот заголовок содержит список всех серверов, через которые прошел запрос, включая IP-адрес клиента.
- X-Forwarded-Proto: Этот заголовок указывает протокол (HTTP или HTTPS), используемый в исходном запросе клиента.
### Реализация настроек заголовка прокси-сервера в Nginx
Чтобы установить эти заголовки в вашей конфигурации Nginx, вы должны изменить блок location в вашем блоке server. Вот пример того, как вы можете установить эти заголовки:
```
server {
    listen 80;
    location / {
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://backendserver_address;
    }
}
```
В этой конфигурации $remote_addr и $scheme — это переменные, которые Nginx автоматически заполняет IP-адресом клиента и схемой запроса (HTTP или HTTPS) соответственно.

## Лучшие практики для заголовков прокси
При настройке заголовков прокси важно учитывать безопасность и точность пересылаемой информации. Чтобы предотвратить потенциальный спуфинг, убедитесь, что ваши внутренние серверы настроены на доверие этим заголовкам только тогда, когда они приходят с вашего обратного прокси Nginx.